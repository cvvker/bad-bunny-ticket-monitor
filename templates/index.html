<!DOCTYPE html>
<html>
<head>
    <title>Bad Bunny Ticket Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Previous styles remain unchanged */
        .ticket-card {
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .month-divider {
            background: #f8f9fa;
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            color: #198754;
            font-weight: bold;
        }
        /* Status Colors and Animations */
        .badge.alert-success {
            background-color: #28a745 !important;
            color: white;
            animation: pulse 2s infinite;
        }
        .badge.alert-warning {
            background-color: #ffc107 !important;
            color: #000;
        }
        .badge.alert-info {
            background-color: #17a2b8 !important;
            color: white;
        }
        .badge.alert-danger {
            background-color: #dc3545 !important;
            color: white;
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both infinite;
        }
        .urgent-alert {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both infinite;
            transform: translate3d(0, 0, 0);
            background-color: #ff4444 !important;
            border-color: #ff4444 !important;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .status-alert {
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            transition: background-color 0.3s ease;
        }
        .status-alert.alert-success {
            background-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }
        .status-alert.alert-warning {
            background-color: #ffc107;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        .status-alert.alert-danger {
            background-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        .status-alert.alert-info {
            background-color: #17a2b8;
            box-shadow: 0 0 10px rgba(23, 162, 184, 0.5);
        }
        /* Timer and Control Panel Styles */
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
            min-width: 200px;
        }
        .countdown-ring {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
        }
        .countdown-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .countdown-circle circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            fill: none;
            stroke-width: 4;
        }
        .countdown-circle .progress {
            stroke: #28a745;
            transition: stroke-dashoffset 0.1s linear;
        }
        .countdown-circle .bg {
            stroke: #e9ecef;
        }
        .countdown-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }
        .next-check-time {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .notification-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .month-section {
            background-color: #f8f9fa;
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            color: #198754;
            font-weight: bold;
        }
        .month-title {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Bad Bunny Ticket Monitor</h1>
        
        <div class="timer-container">
            <div class="countdown-ring">
                <svg class="countdown-circle" width="60" height="60">
                    <circle class="bg" cx="30" cy="30" r="25"/>
                    <circle class="progress" cx="30" cy="30" r="25"/>
                </svg>
                <div class="countdown-number">15</div>
            </div>
            <div>Next Check In</div>
            <div class="next-check-time" id="nextCheckTime"></div>
        </div>

        <div class="alert alert-info text-center">
            Monitoring Ticketera for Bad Bunny ticket availability
            <div class="mt-2">
                <small>Auto-refreshing every 15 seconds</small>
            </div>
        </div>
        
        <div id="tickets-container"></div>
    </div>

    <div class="notification-toggle">
        <button class="btn btn-success" onclick="toggleSound()" id="soundToggle">
            🔔 Sound ON
        </button>
        <button class="btn btn-info" onclick="testNotification()">
            🔊 Test Alert
        </button>
    </div>

    <audio id="alertSound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAASAAAeMwAUFBQUFCgoKCgoKDw8PDw8PFBQUFBQUG5ubm5uboKCgoKCgpaWlpaWlqqqqqqqqr6+vr6+vtLS0tLS0ubm5ubm5vr6+vr6+v8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAQKAAAAAAAAHjOZTf9C//MsAAAAAAAAAAAAAAAAAAAA//tQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACzAAICAg4ODg4SEhISEhoaGhoaHh4eHh4iIiIiIiYmJiYmKioqKiouLi4uLjMzMzMzNzc3Nzc8PDw8PD4+Pj4+P8AAAAATGF2ZTU4LjEzAAAAAAAAAAAAAAAAJAQGAAAAAAAACs3yxUAAAAAAAAAAAAAAAAAAAAAA//sQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+xBkBY/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAARVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        let soundEnabled = true;
        let lastPlayedTime = 0;
        const MIN_PLAY_INTERVAL = 1000; // Minimum 1 second between plays

        // Initialize sound preference from localStorage
        try {
            const savedSound = localStorage.getItem('soundEnabled');
            if (savedSound !== null) {
                soundEnabled = savedSound === 'true';
            }
        } catch (e) {
            console.error('Error accessing localStorage:', e);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            try {
                localStorage.setItem('soundEnabled', soundEnabled);
            } catch (e) {
                console.error('Error saving sound preference:', e);
            }
            updateSoundButton();
            // Play test sound when enabling
            if (soundEnabled) {
                playAlertSound();
            }
        }

        function updateSoundButton() {
            const button = document.getElementById('soundToggle');
            button.innerHTML = soundEnabled ? '🔔 Sound ON' : '🔕 Sound OFF';
            button.classList.toggle('btn-success', soundEnabled);
            button.classList.toggle('btn-secondary', !soundEnabled);
        }

        async function playAlertSound() {
            if (!soundEnabled) return;
            
            const now = Date.now();
            if (now - lastPlayedTime < MIN_PLAY_INTERVAL) {
                console.log('Skipping sound, too soon after last play');
                return;
            }

            const audio = document.getElementById('alertSound');
            
            try {
                // Reset and load the audio
                audio.currentTime = 0;
                await audio.load();
                
                // Create and start a new play promise
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            lastPlayedTime = now;
                            console.log('Sound played successfully');
                        })
                        .catch(error => {
                            console.error('Error playing sound:', error);
                            // Try to play again with user interaction
                            const retryPlay = () => {
                                audio.play()
                                    .then(() => lastPlayedTime = Date.now())
                                    .catch(e => console.error('Retry failed:', e));
                                document.removeEventListener('click', retryPlay);
                            };
                            document.addEventListener('click', retryPlay, { once: true });
                        });
                }
            } catch (e) {
                console.error('Error in playAlertSound:', e);
            }
        }

        function testNotification() {
            const testCard = document.querySelector('.ticket-card');
            if (testCard) {
                testCard.classList.add('urgent-alert');
                setTimeout(() => testCard.classList.remove('urgent-alert'), 2000);
            }
            playAlertSound();
        }

        let previousStates = {};
        const CHECK_INTERVAL = 15000; // 15 seconds
        let lastCheckTime = new Date();

        function updateCountdown() {
            const now = new Date();
            const timeSinceLastCheck = now - lastCheckTime;
            const timeUntilNextCheck = Math.max(0, CHECK_INTERVAL - timeSinceLastCheck);
            const secondsLeft = Math.ceil(timeUntilNextCheck / 1000);
            
            // Update countdown number
            const countdownNumber = document.querySelector('.countdown-number');
            countdownNumber.textContent = secondsLeft;
            
            // Update progress circle
            const progress = document.querySelector('.countdown-circle .progress');
            const percentage = (timeUntilNextCheck / CHECK_INTERVAL) * 100;
            const dashOffset = 283 * (1 - percentage / 100);
            progress.style.strokeDashoffset = dashOffset;
            
            // Update next check time
            const nextCheckTime = new Date(lastCheckTime.getTime() + CHECK_INTERVAL);
            document.getElementById('nextCheckTime').textContent = 
                nextCheckTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function createEventCard(id, event) {
            const div = document.createElement('div');
            div.className = 'col-md-4 mb-4';
            div.setAttribute('data-event-id', id);
            
            let statusClass = 'alert-info';
            let urgencyClass = '';
            
            if (event.status.includes('AVAILABLE')) {
                statusClass = 'alert-success';
                urgencyClass = 'urgent-alert';
            } else if (event.status.includes('Not Available')) {
                statusClass = 'alert-danger';
            } else if (event.status.includes('CHECK NOW')) {
                statusClass = 'alert-warning';
                urgencyClass = 'urgent-alert';
            }

            div.innerHTML = `
                <div class="card ticket-card ${urgencyClass}">
                    <div class="status-alert ${statusClass}"></div>
                    <div class="card-body">
                        <h5 class="card-title">${event.name}</h5>
                        <div class="status-badge badge ${statusClass} mb-2">
                            ${event.status}
                        </div>
                        <p class="card-text">
                            <small class="text-muted">
                                Last checked: ${event.lastChecked}
                            </small>
                        </p>
                        ${event.url ? `
                            <a href="${event.url}" target="_blank" class="btn btn-primary btn-sm">
                                Check Tickets 🎟️
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;

            // Add click handler to play sound when urgent
            if (urgencyClass) {
                const card = div.querySelector('.ticket-card');
                card.addEventListener('click', () => {
                    if (event.status.includes('AVAILABLE')) {
                        playAlertSound();
                    }
                });
            }

            return div;
        }

        function updateDisplay() {
            fetch('/api/tickets')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('tickets-container');
                    container.innerHTML = '';

                    // Group events by month
                    const months = {
                        'July': [],
                        'August': [],
                        'September': []
                    };

                    // If data is empty or has errors, create fallback data
                    if (Object.keys(data).length === 0 || data.error) {
                        // Add fallback data for all dates from memory
                        const fallbackDates = {
                            'July': ['12', '18', '19'],
                            'August': ['1', '2', '3', '8', '9', '10', '15', '16', '17', '22', '23', '24', '29', '30', '31'],
                            'September': ['5', '6', '7', '12', '13', '14']
                        };
                        
                        Object.entries(fallbackDates).forEach(([month, days]) => {
                            days.forEach(day => {
                                const id = `${month.toLowerCase()}-${day}`;
                                const date = `${month} ${day}, 2025`;
                                data[id] = {
                                    name: `Bad Bunny - ${date}`,
                                    date: date,
                                    status: "⚡ Not Yet Available",
                                    url: `#${month}-${day}`,
                                    lastChecked: new Date().toLocaleTimeString()
                                };
                            });
                        });
                    }

                    Object.entries(data).forEach(([id, event]) => {
                        const month = event.date.split(',')[0].trim();
                        if (months[month]) {
                            months[month].push({ id, ...event });
                        }
                    });

                    // Sort events within each month by day
                    Object.values(months).forEach(monthEvents => {
                        monthEvents.sort((a, b) => {
                            const dayA = parseInt(a.date.split(',')[0].split(' ')[1]);
                            const dayB = parseInt(b.date.split(',')[0].split(' ')[1]);
                            return dayA - dayB;
                        });
                    });

                    // Check for status changes and trigger notifications
                    Object.entries(data).forEach(([id, event]) => {
                        const prevStatus = previousStates[id]?.status;
                        const currentStatus = event.status;

                        if (prevStatus && prevStatus !== currentStatus) {
                            if (currentStatus.includes('AVAILABLE')) {
                                playAlertSound();
                                const card = document.querySelector(`[data-event-id="${id}"]`);
                                if (card) {
                                    card.classList.add('urgent-alert');
                                    setTimeout(() => card.classList.remove('urgent-alert'), 5000);
                                }
                            } else if (currentStatus.includes('CHECK NOW')) {
                                playAlertSound();
                            }
                        }
                    });

                    // Update previous states
                    previousStates = Object.entries(data).reduce((acc, [id, event]) => {
                        acc[id] = { status: event.status };
                        return acc;
                    }, {});

                    // Display events in order
                    ['July', 'August', 'September'].forEach(month => {
                        if (months[month].length > 0) {
                            const monthDiv = document.createElement('div');
                            monthDiv.className = 'month-section mb-4';
                            monthDiv.innerHTML = `<h2 class="month-title">${month} 2025</h2>`;
                            container.appendChild(monthDiv);

                            const row = document.createElement('div');
                            row.className = 'row';
                            months[month].forEach(event => {
                                row.appendChild(createEventCard(event.id, event));
                            });
                            container.appendChild(row);
                        }
                    });

                    // Update last check time
                    lastCheckTime = new Date();
                    updateCountdown();
                })
                .catch(error => {
                    console.error('Error fetching tickets:', error);
                });
        }

        // Initialize
        updateSoundButton();
        updateDisplay();
        setInterval(updateDisplay, CHECK_INTERVAL);
        setInterval(updateCountdown, 1000);

        // Test audio loading
        const audio = document.getElementById('alertSound');
        audio.load();
    </script>
</body>
</html>
